{% extends 'base.html' %}
{% block body %}
<div class="container" style="text-align:center">
    <div class="row" style="margin-top:1rem">
        <div class="col" style="text-align:center">
            <img src={{movie.poster_url}} width='400px'>
        </div>

        <div class="card col" style="width: 18rem;">
            <div class="card-body">
                <h1 class="card-title">{{movie.title}} ({{movie.genre.name}})</h1>
                <h6 class="card-subtitle mb-2 text-muted">누적 관객수: {{movie.audience}}</h6><br>
                <h3 class="card-subtitle mb-2">줄거리</h3>
                <hr>
                <p class="card-text">{{movie.description}}</p>
                <hr>
                {% if user.is_authenticated %}
                <form action="{% url 'movies:like_movie' movie.pk %}" method="POST">
                    {% csrf_token %}
                    {% if user in movie.like_users.all %}
                    <i id="like-button" data-id="{{movie.id}}" class="fas fa-thumbs-up " style="color:red"></i>
                    {% else %}
                    <i id="like-button" data-id="{{movie.id}}" class="far fa-thumbs-up " style="color:red"></i>
                    {% endif %}
                </form>
                {% endif %}
                <p><span id="like-count">{{ movie.like_users.count }}</span>명이 이 글을 좋아합니다. </p>
            </div>
        </div>
    </div>
    <hr>


    <hr>

    <h2>평점을 작성해주세요</h2>
    {% for review in movie.review_set.all %}
    <p>
        {{review.user}} ({{review.score}}점)<br>
        <form action='reviews/{{review.pk}}/delete' method='POST'>
            {{review.content}}
            {% csrf_token %}
            <input class="btn btn-outline-danger" type="submit" value="삭제" onclick="return confirm('삭제하려면 클릭해주세요')">
        </form>

    </p>
    <hr>
    {% endfor %}
    <form action="{% url 'movies:review' movie.pk %}" method='POST'>
        {% csrf_token %}
        {{form.as_p}}
        <input type='submit' value='등록'>
    </form>


    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        axios.get(
                "https://images.unsplash.com/photo-1542204165-65bf26472b9b?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1267&q=80"
                )
            .then(response => {
                document.body.style.backgroundImage = `url(${response.request.responseURL})`
                document.body.style.backgroundPosition = 'center'
                document.body.style.backgroundSize = 'cover'
                document.body.style.backgroundRepeat = 'no-repeat'

            })
    </script>
    {% endblock %}
    {% block script %}
    <script>
        const likeButton = document.querySelector('#like-button')
        likeButton.addEventListener('click', function (event) {
            console.log(event.target.dataset)
            axios.defaults.xsrfCookieName = 'csrftoken'
            axios.defaults.xsrfHeaderName = 'X-CSRFToken'
            axios.defaults.headers.common['X-REQUESTED-WITH'] = 'XMLHttpRequest'
            axios.post(`/movies/${event.target.dataset.id}/like/`)
                .then(response => {
                    const likeCount = document.querySelector('#like-count')
                    console.log(response)
                    console.log(event.target)
                    if (response.data.is_liked) {
                        event.target.classList.remove('far')
                        event.target.classList.add('fas')
                    } else {
                        event.target.classList.remove('fas')
                        event.target.classList.add('far')
                    }
                    likeCount.innerText = response.data.like_count
                })
                .catch(error => {
                    console.log(error)
                })
        })
    </script>
    {% endblock %}
